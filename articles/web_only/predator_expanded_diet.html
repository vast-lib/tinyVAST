<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Predator expanded diet • tinyVAST</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../../favicon.ico">
<link rel="manifest" href="../../site.webmanifest">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Predator expanded diet">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">tinyVAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../../articles/web_only/overview.html">Overview of vignettes</a></li>
    <li><a class="dropdown-item" href="../../articles/model-description.html">tinyVAST model description</a></li>
    <li><a class="dropdown-item" href="../../articles/mgcv.html">Comparison with mgcv</a></li>
    <li><a class="dropdown-item" href="../../articles/spatial.html">Spatial modeling</a></li>
    <li><a class="dropdown-item" href="../../articles/multiple_data.html">Multiple data types</a></li>
    <li><a class="dropdown-item" href="../../articles/dsem.html">Dynamic structural equation models</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/simultaneous_autoregressive_process.html">Simultaneous autoregressive process</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/stream_networks.html">Stream network models</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/age_composition_expansion.html">Age composition expansion</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/condition.html">Condition and density</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/empirical_orthogonal_functions.html">Empirical orthogonal functions</a></li>
    <li><a class="dropdown-item" href="../../articles/spatial_factor_analysis.html">Spatial factor analysis</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/VAST.html">Vector autoregressive spatio-temporal models</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/predator_expanded_diet.html">Predator expanded diet</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/spatial_structural_model.html">Spatial structural models</a></li>
    <li><a class="dropdown-item" href="../../articles/web_only/probabilistic_forecasts.html">Probabilistic forecasts</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/vast-lib/tinyVAST/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Predator expanded diet</h1>
                        <h4 data-toc-skip class="author">James T.
Thorson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/vast-lib/tinyVAST/blob/HEAD/vignettes/web_only/predator_expanded_diet.Rmd" class="external-link"><code>vignettes/web_only/predator_expanded_diet.Rmd</code></a></small>
      <div class="d-none name"><code>predator_expanded_diet.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vast-lib.github.io/tinyVAST/">tinyVAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inlabru-org.github.io/fmesher/" class="external-link">fmesher</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p># Joint model for stomach content, predator biomass catch rate, and
predator-expanded-stomach-contents (PESCs)</p>
<p>We developed an approach that fits a spatio-temporal model with
<code>VAST</code> to both prey-biomass-per-predator-mass data (i.e., the
ratio of prey biomass in stomachs to predator weight) and predator
biomass catch rate data (predator biomass per unit area), to predict
“predator-expanded-stomach-contents” (PESC; the product of
prey-biomass-per-predator-biomass, predator biomass per unit area, and
surface area) <span class="citation">(Grüss et al. 2020)</span>. The
PESC estimates can be used to visualize either the annual landscape of
PESC (spatio-temporal variation), or can be aggregated across space to
calculate annual variation in diet proportions (variation among prey
items and among years).</p>
<p>Here, we demonstrate our approach in a data-limited situation
involving West Florida Shelf red grouper (Epinephelus morio,
Epinephelidae) for 2011-2015. Four prey items are considered: crabs,
fish, shrimps, and “other prey”. We demonstrate how diet proportions are
calculated from the PESCs estimated by our model.</p>
<p>One key step is specifying how the index is calculated. In our case,
we calculate the estimated biomass (the product of biomass per unit area
and surface area) for the first “category”, namely the predator (red
grouper), will be multiplied by the estimated
prey-biomass-per-predator-biomass for the other categories, namely the
prey items (crabs, fish, other prey, and shrimps), to obtain PESC
estimates (for crabs, fish, other prey, and shrimps).</p>
<p>For more information about the approach and its outcomes, please
read: Grüss A, Thorson JT, Carroll G, Ng EL, Holsman KK, Aydin K,
Kotwicki S, Morzaria-Luna HM, Ainsworth CH, Thompson KA (2020).
Spatio-temporal analyses of marine predator diets from data-rich and
data-limited systems. Fish and Fisheries, 21: 718-739.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># We load two datasets:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span> <span class="va">red_grouper_diet</span> <span class="op">)</span></span>
<span><span class="co"># (1) A predator biomass catch rate dataset, where biomass catch rate is in kg per square-km</span></span>
<span><span class="co"># (2) A stomach content dataset, providing prey biomass data (in g) and predator mass data (in g)</span></span>
<span><span class="va">Predator_biomass_cath_rate_data</span> <span class="op">=</span> <span class="va">red_grouper_diet</span><span class="op">$</span><span class="va">Predator_biomass_cath_rate_data</span></span>
<span><span class="va">Stomach_content_data</span> <span class="op">=</span> <span class="va">red_grouper_diet</span><span class="op">$</span><span class="va">Stomach_content_data</span></span>
<span></span>
<span><span class="co"># Modify the predator biomass catch rate dataset. Specifically:</span></span>
<span><span class="co"># (1) Assign a new "Category" field to the dataset (with the unique level "Red_grouper")</span></span>
<span><span class="va">Predator_biomass_cath_rate_data</span><span class="op">$</span><span class="va">Category</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span> <span class="st">"Red_grouper"</span> <span class="op">)</span></span>
<span><span class="co"># (2) Rename the "CPUE_kg_km2" field into "Response_variable" - to allow for</span></span>
<span><span class="co"># the merging of the predator biomass catch rate and stomach content datasets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span> <span class="va">Predator_biomass_cath_rate_data</span> <span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Response_variable"</span></span>
<span><span class="co"># Note that a_i = 1 because `Response_variable` is already KG per KM^2; Future</span></span>
<span><span class="co"># applications could instead treate `Response_variable` as KG and use `a_i` as</span></span>
<span><span class="co"># area swept</span></span>
<span></span>
<span><span class="co"># Modify the stomach content dataset. Specifically:</span></span>
<span><span class="co"># (1) Create a new "predator-biomass-per-predator-mass" variable (in g per g of predator), by dividing</span></span>
<span><span class="co"># prey biomass (in g) by predator mass (in g)</span></span>
<span><span class="va">Stomach_content_data</span><span class="op">$</span><span class="va">Prey_biomass_per_predator_mass</span> <span class="op">&lt;-</span> <span class="va">Stomach_content_data</span><span class="op">$</span><span class="va">Prey_biomass_in_stomach_g</span> <span class="op">/</span></span>
<span>    <span class="va">Stomach_content_data</span><span class="op">$</span><span class="va">Predator_mass_g</span></span>
<span><span class="co"># (2) Rename the "Prey_item" field into "Category" (levels: "Crabs", "Fish", "Shrimps", and "Other") - to allow for</span></span>
<span><span class="co"># the merging of the predator biomass catch rate and stomach content datasets</span></span>
<span><span class="va">Stomach_content_data</span><span class="op">$</span><span class="va">Category</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span> <span class="va">Stomach_content_data</span><span class="op">$</span><span class="va">Prey_item</span> <span class="op">)</span></span>
<span><span class="co"># (3) Reorder the columns of the dataset - to allow for</span></span>
<span><span class="co"># the merging of the predator biomass catch rate and stomach content datasets</span></span>
<span><span class="va">Stomach_content_data</span> <span class="op">&lt;-</span> <span class="va">Stomach_content_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">1</span> <span class="op">:</span> <span class="fl">3</span>, <span class="fl">8</span>, <span class="fl">7</span>, <span class="fl">9</span> <span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># (4) Rename the "predator-biomass-per-predator-mass" field into "Response_variable" - to allow for</span></span>
<span><span class="co"># the merging of the predator biomass catch rate and stomach content datasets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span> <span class="va">Stomach_content_data</span> <span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Response_variable"</span></span>
<span><span class="co"># (5) Change a_i = 1, because `Response_variable` is already prey-G per predator-G, such that</span></span>
<span><span class="co"># product of c=0 and c = {1,2,3,4} has units KG</span></span>
<span><span class="va">Stomach_content_data</span><span class="op">$</span><span class="va">Area_swept_km2</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="co"># Note that future applications could instead treat</span></span>
<span><span class="co"># `Response_variable` as prey-biomass and `a_i` as predator-body-size</span></span>
<span></span>
<span><span class="co"># Merge the predator biomass catch rate and stomach content datasets</span></span>
<span><span class="va">sampling_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span> <span class="va">Predator_biomass_cath_rate_data</span>, <span class="va">Stomach_content_data</span> <span class="op">)</span></span></code></pre></div>
<p>After assembling the data in a long-form data frame, we can run the
model using standard syntax:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make mesh</span></span>
<span><span class="va">mesh</span> <span class="op">=</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_2d.html" class="external-link">fm_mesh_2d</a></span><span class="op">(</span></span>
<span>  loc <span class="op">=</span> <span class="va">sampling_data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lon"</span>,<span class="st">"Lat"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>  cutoff <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the distribution for each category</span></span>
<span><span class="va">Family</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  Red_grouper <span class="op">=</span> <span class="fu"><a href="https://pbs-assess.github.io/sdmTMB/reference/families.html" class="external-link">tweedie</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Crabs <span class="op">=</span> <span class="fu"><a href="https://pbs-assess.github.io/sdmTMB/reference/families.html" class="external-link">tweedie</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Fish <span class="op">=</span> <span class="fu"><a href="https://pbs-assess.github.io/sdmTMB/reference/families.html" class="external-link">tweedie</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Shrimps <span class="op">=</span> <span class="fu"><a href="https://pbs-assess.github.io/sdmTMB/reference/families.html" class="external-link">tweedie</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  Other <span class="op">=</span> <span class="fu"><a href="https://pbs-assess.github.io/sdmTMB/reference/families.html" class="external-link">tweedie</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Same spatial SD for prey species (given sparsity of data)</span></span>
<span><span class="va">space_term</span> <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  Red_grouper &lt;-&gt; Red_grouper, sd_predator</span></span>
<span><span class="st">  Crabs &lt;-&gt; Crabs, sd_prey</span></span>
<span><span class="st">  Fish &lt;-&gt; Fish, sd_prey</span></span>
<span><span class="st">  Shrimps &lt;-&gt; Shrimps, sd_prey</span></span>
<span><span class="st">  Other &lt;-&gt; Other, sd_prey</span></span>
<span><span class="st">"</span></span>
<span><span class="co"># Ditto</span></span>
<span><span class="va">spacetime_term</span> <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  Red_grouper &lt;-&gt; Red_grouper, 0, sd_predator</span></span>
<span><span class="st">  Crabs &lt;-&gt; Crabs, 0, sd_prey</span></span>
<span><span class="st">  Fish &lt;-&gt; Fish, 0, sd_prey</span></span>
<span><span class="st">  Shrimps &lt;-&gt; Shrimps, 0, sd_prey</span></span>
<span><span class="st">  Other &lt;-&gt; Other, 0, sd_prey</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="co"># Run</span></span>
<span><span class="va">fit</span> <span class="op">=</span> <span class="fu"><a href="../../reference/tinyVAST.html">tinyVAST</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">Response_variable</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">Category</span>, <span class="va">Year</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Area_swept_km2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">sampling_data</span>,</span>
<span>  spatial_domain <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>  family <span class="op">=</span> <span class="va">Family</span>,</span>
<span>  space_term <span class="op">=</span> <span class="va">space_term</span>,</span>
<span>  spacetime_term <span class="op">=</span> <span class="va">spacetime_term</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">2011</span><span class="op">:</span><span class="fl">2015</span>,</span>
<span>  <span class="co"># labelling</span></span>
<span>  space_columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lon"</span>,<span class="st">"Lat"</span><span class="op">)</span>,</span>
<span>  time_column <span class="op">=</span> <span class="st">"Year"</span>,</span>
<span>  variable_column <span class="op">=</span> <span class="st">"Category"</span>,</span>
<span>  distribution_column <span class="op">=</span> <span class="st">"Category"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We then calculate the index of predator-expanded stomach contents for
each prey:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get extrapolation grid</span></span>
<span><span class="va">extrap</span> <span class="op">=</span> <span class="va">red_grouper_diet</span><span class="op">$</span><span class="va">input_grid</span></span>
<span></span>
<span><span class="co">#</span></span>
<span><span class="va">newdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="co"># Predator-expanded biomass in 2015</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="va">extrap</span>, Category <span class="op">=</span> <span class="st">"Red_grouper"</span>, Year <span class="op">=</span> <span class="fl">2015</span>, Area_swept_km2 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="co"># Specific consumption for Crabs in 2015</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="va">extrap</span>, Category <span class="op">=</span> <span class="st">"Crabs"</span>, Year <span class="op">=</span> <span class="fl">2015</span>, Area_swept_km2 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get predictions</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">newdata</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute predator-expanded consumption manually</span></span>
<span><span class="va">predator_biomass</span> <span class="op">=</span> <span class="va">pred</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">extrap</span><span class="op">$</span><span class="va">Area_km2</span></span>
<span><span class="va">specific_consumption</span> <span class="op">=</span> <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">total</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span> <span class="va">predator_biomass</span> <span class="op">*</span> <span class="va">specific_consumption</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Or get standard error and bias-corrected estimator using built-in function</span></span>
<span><span class="va">index</span> <span class="op">=</span> <span class="fu"><a href="../../reference/integrate_output.html">integrate_output</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">fit</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">newdata</span>,</span>
<span>  area <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="va">extrap</span><span class="op">$</span><span class="va">Area_km2</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>,</span>
<span>  type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">4</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span> <span class="op">)</span>,</span>
<span>  weighting_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">)</span>, <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can loop across prey to get the proportions by year and
prey. Here, we do this manually (i.e., without bias-correction or
standard errors) to save computation time.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">index_ct</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>,</span>
<span>  dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>,<span class="fl">5</span><span class="op">)</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> Category <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">Stomach_content_data</span><span class="op">$</span><span class="va">Category</span><span class="op">)</span>,</span>
<span>                   Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">sampling_data</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Loop through prey and years</span></span>
<span><span class="kw">for</span><span class="op">(</span> <span class="va">ci</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">index_ct</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span></span>
<span><span class="kw">for</span><span class="op">(</span> <span class="va">ti</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">index_ct</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Modify newdata</span></span>
<span>  <span class="va">newdata</span><span class="op">$</span><span class="va">Year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">index_ct</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">ti</span><span class="op">]</span></span>
<span>  <span class="va">newdata</span><span class="op">$</span><span class="va">Category</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="va">newdata</span><span class="op">$</span><span class="va">Category</span> <span class="op">==</span> <span class="st">"Red_grouper"</span>,</span>
<span>                             <span class="st">"Red_grouper"</span>,</span>
<span>                             <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">index_ct</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">ci</span><span class="op">]</span> <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get predictions</span></span>
<span>  <span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">newdata</span> <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Compute predator-expanded consumption manually</span></span>
<span>  <span class="va">predator_biomass</span> <span class="op">=</span> <span class="va">pred</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">extrap</span><span class="op">$</span><span class="va">Area_km2</span></span>
<span>  <span class="va">specific_consumption</span> <span class="op">=</span> <span class="va">pred</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">extrap</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">index_ct</span><span class="op">[</span><span class="va">ci</span>,<span class="va">ti</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span> <span class="va">predator_biomass</span> <span class="op">*</span> <span class="va">specific_consumption</span> <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Calculate diet proportion by year</span></span>
<span><span class="va">proportion_ct</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sweep.html" class="external-link">sweep</a></span><span class="op">(</span> <span class="va">index_ct</span>, MARGIN <span class="op">=</span> <span class="fl">2</span>, FUN <span class="op">=</span> <span class="st">"/"</span>, STAT <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">index_ct</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">proportions</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">proportion_ct</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">proportions</span><span class="op">$</span><span class="va">prop</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">proportion_ct</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot consumption proportion by prey and year</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span> <span class="va">proportions</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">prop</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">Category</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p><img src="predator_expanded_diet_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<p>Runtime for this vignette: 34.8 secs</p>
<div class="section level3 unnumbered">
<h3 class="unnumbered" id="works-cited">Works cited<a class="anchor" aria-label="anchor" href="#works-cited"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-gruss_spatio-temporal_2020" class="csl-entry">
Grüss, Arnaud, James T. Thorson, Gemma Carroll, Elizabeth L. Ng, Kirstin
K. Holsman, Kerim Aydin, Stan Kotwicki, Hem N. Morzaria-Luna, Cameron H.
Ainsworth, and Kevin A. Thompson. 2020. <span>“Spatio-Temporal Analyses
of Marine Predator Diets from Data-Rich and Data-Limited
Systems.”</span> <em>Fish and Fisheries</em> 21 (4): 718–39. <a href="https://doi.org/10.1111/faf.12457" class="external-link">https://doi.org/10.1111/faf.12457</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James T. Thorson, Sean C. Anderson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
