<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatial modeling â€¢ tinyVAST</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Spatial modeling">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">tinyVAST</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.7.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/aaa.html">Overview of vignettes</a></li>
    <li><a class="dropdown-item" href="../articles/web_only/age_composition_expansion.html">Age composition expansion</a></li>
    <li><a class="dropdown-item" href="../articles/web_only/condition.html">Condition and density</a></li>
    <li><a class="dropdown-item" href="../articles/dsem.html">Dynamic structural equation models</a></li>
    <li><a class="dropdown-item" href="../articles/web_only/empirical_orthogonal_functions.html">Empirical orthogonal functions</a></li>
    <li><a class="dropdown-item" href="../articles/mgcv.html">Comparison with mgcv</a></li>
    <li><a class="dropdown-item" href="../articles/multiple_data.html">Multiple data types</a></li>
    <li><a class="dropdown-item" href="../articles/simultaneous_autoregressive_process.html">Simultaneous autoregressive process</a></li>
    <li><a class="dropdown-item" href="../articles/spatial_factor_analysis.html">Spatial factor analysis</a></li>
    <li><a class="dropdown-item" href="../articles/spatial.html">Spatial modeling</a></li>
    <li><a class="dropdown-item" href="../articles/web_only/stream_networks.html">Stream network models</a></li>
    <li><a class="dropdown-item" href="../articles/web_only/VAST.html">Vector autoregressive spatio-temporal models</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/vast-lib/tinyVAST/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spatial modeling</h1>
                        <h4 data-toc-skip class="author">James T.
Thorson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/vast-lib/tinyVAST/blob/main/vignettes/spatial.Rmd" class="external-link"><code>vignettes/spatial.Rmd</code></a></small>
      <div class="d-none name"><code>spatial.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vast-lib.github.io/tinyVAST/" class="external-link">tinyVAST</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://inlabru-org.github.io/fmesher/" class="external-link">fmesher</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bgreenwell/pdp" class="external-link">pdp</a></span><span class="op">)</span>  <span class="co"># approx = TRUE gives effects for average of other covariates</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="st">"tinyVAST.verbose"</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><code>tinyVAST</code> is an R package for fitting vector
autoregressive spatio-temporal (VAST) models using a minimal and
user-friendly interface. We here show how it can fit spatial
autoregressive model. We first simulate a spatial random field and a
confounder variable, and simulate data from this simulated process.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate a 2D AR1 spatial process with a cyclic confounder w</span></span>
<span><span class="va">n_x</span> <span class="op">=</span> <span class="va">n_y</span> <span class="op">=</span> <span class="fl">25</span></span>
<span><span class="va">n_w</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="va">R_xx</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_x</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_x</span>, FUN<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">R_yy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.4</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_y</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_y</span>, FUN<span class="op">=</span><span class="st">"-"</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">z</span> <span class="op">=</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="fl">1</span>, sigma<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/kronecker.html" class="external-link">kronecker</a></span><span class="op">(</span><span class="va">R_xx</span>,<span class="va">R_yy</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate nuissance parameter z from oscillatory (day-night) process</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_w</span>, replace<span class="op">=</span><span class="cn">TRUE</span>, size<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">n_x</span>, y<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">n_y</span><span class="op">)</span>, w<span class="op">=</span><span class="va">w</span>, z<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">w</span><span class="op">/</span><span class="va">n_w</span><span class="op">*</span><span class="fl">2</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Data</span><span class="op">$</span><span class="va">n</span> <span class="op">=</span> <span class="va">Data</span><span class="op">$</span><span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">Data</span><span class="op">)</span>, sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add columns for multivariate and temporal dimensions</span></span>
<span><span class="va">Data</span><span class="op">$</span><span class="va">var</span> <span class="op">=</span> <span class="st">"density"</span></span>
<span><span class="va">Data</span><span class="op">$</span><span class="va">time</span> <span class="op">=</span> <span class="fl">2020</span></span></code></pre></div>
<p>We next construct a triangulated mesh that represents our continuous
spatial domain</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># make mesh</span></span>
<span><span class="va">mesh</span> <span class="op">=</span> <span class="fu"><a href="https://inlabru-org.github.io/fmesher/reference/fm_mesh_2d.html" class="external-link">fm_mesh_2d</a></span><span class="op">(</span> <span class="va">Data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'x'</span>,<span class="st">'y'</span><span class="op">)</span><span class="op">]</span>, cutoff <span class="op">=</span> <span class="fl">2</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot it</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mesh</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>Finally, we can fit these data using <code>tinyVAST</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define sem, with just one variance for the single variable</span></span>
<span><span class="va">sem</span> <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">  density &lt;-&gt; density, spatial_sd</span></span>
<span><span class="st">"</span></span>
<span></span>
<span><span class="co"># fit model</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="../reference/tinyVAST.html">tinyVAST</a></span><span class="op">(</span> data <span class="op">=</span> <span class="va">Data</span>,</span>
<span>           formula <span class="op">=</span> <span class="va">n</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span>,</span>
<span>           spatial_graph <span class="op">=</span> <span class="va">mesh</span>,</span>
<span>           control <span class="op">=</span> <span class="fu"><a href="../reference/tinyVASTcontrol.html">tinyVASTcontrol</a></span><span class="op">(</span>getsd<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>           sem <span class="op">=</span> <span class="va">sem</span><span class="op">)</span></span></code></pre></div>
<p>We can then calculate the area-weighted total abundance:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Predicted sample-weighted total</span></span>
<span><span class="fu"><a href="../reference/integrate_output.html">integrate_output</a></span><span class="op">(</span><span class="va">out</span>, newdata <span class="op">=</span> <span class="va">out</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="co">#&gt;            Estimate          Std. Error Est. (bias.correct) Std. (bias.correct) </span></span>
<span><span class="co">#&gt;          -104.15036            29.90545          -104.15036                  NA</span></span>
<span><span class="co"># integrate_output(out, apply.epsilon=TRUE )</span></span>
<span><span class="co"># predict(out)</span></span>
<span></span>
<span><span class="co"># True (latent) sample-weighted total</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span> <span class="va">Data</span><span class="op">$</span><span class="va">z</span> <span class="op">)</span></span>
<span><span class="co">#&gt; [1] -92.89517</span></span></code></pre></div>
<div class="section level2">
<h2 id="percent-deviance-explained">Percent deviance explained<a class="anchor" aria-label="anchor" href="#percent-deviance-explained"></a>
</h2>
<p>We can compute deviance residuals and percent-deviance explained:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Percent deviance explained</span></span>
<span><span class="va">out</span><span class="op">$</span><span class="va">deviance_explained</span></span>
<span><span class="co">#&gt; [1] 0.5051624</span></span></code></pre></div>
<p>We can then compare this with the PDE reported by
<code>mgcv</code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">mygam</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span> <span class="va">n</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span>, data<span class="op">=</span><span class="va">Data</span> <span class="op">)</span> <span class="co">#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span><span class="co">#&gt; Time difference of 0.03207898 secs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mygam</span><span class="op">)</span><span class="op">$</span><span class="va">dev.expl</span></span>
<span><span class="co">#&gt; [1] 0.3517756</span></span></code></pre></div>
<p>where this comparison shows that using the SPDE method in tinyVAST
results in higher percent-deviance-explained. This reduced performance
for splines relative to the SPDE method presumably arises due to the
reduced rank of the spline basis expansion, and the better match for the
Matern function (in the SPDE method) relative to the true (simulated)
exponential semivariogram.</p>
<p>It is then easy to confirm that mgcv and tinyVAST give (essentially)
identical PDE when switching tinyVAST to use the same bivariate spline
for space.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_reduced</span> <span class="op">=</span> <span class="fu"><a href="../reference/tinyVAST.html">tinyVAST</a></span><span class="op">(</span> data <span class="op">=</span> <span class="va">Data</span>,</span>
<span>                        formula <span class="op">=</span> <span class="va">n</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract PDE for GAM-style spatial smoother in tinyVAST</span></span>
<span><span class="va">out_reduced</span><span class="op">$</span><span class="va">deviance_explained</span></span>
<span><span class="co">#&gt; [1] 0.3497174</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-spatial-response">Visualize spatial response<a class="anchor" aria-label="anchor" href="#visualize-spatial-response"></a>
</h2>
<p><code>tinyVAST</code> then has a standard <code>predict</code>
function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">out</span>, newdata<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">1</span>, y<span class="op">=</span><span class="fl">1</span>, time<span class="op">=</span><span class="fl">1</span>, w<span class="op">=</span><span class="fl">1</span>, var<span class="op">=</span><span class="st">"density"</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3649899</span></span></code></pre></div>
<p>and this is used to compute the spatial response</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prediction grid</span></span>
<span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_x</span>,len<span class="op">=</span><span class="fl">51</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_y</span>,len<span class="op">=</span><span class="fl">51</span><span class="op">)</span>,</span>
<span>              FUN<span class="op">=</span>\<span class="op">(</span><span class="va">x</span>,<span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">out</span>,newdata<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span>,w<span class="op">=</span><span class="fl">1</span>,time<span class="op">=</span><span class="fl">1</span>,var<span class="op">=</span><span class="st">"density"</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span> x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_x</span>,len<span class="op">=</span><span class="fl">51</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_y</span>,len<span class="op">=</span><span class="fl">51</span><span class="op">)</span>, z<span class="op">=</span><span class="va">pred</span>, main<span class="op">=</span><span class="st">"Predicted response"</span> <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_files/figure-html/unnamed-chunk-10-1.png" width="576"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># True value</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span> x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">n_x</span>, y<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">n_y</span>, z<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="va">Data</span><span class="op">$</span><span class="va">z</span>,ncol<span class="op">=</span><span class="va">n_y</span><span class="op">)</span>, main<span class="op">=</span><span class="st">"True response"</span> <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_files/figure-html/unnamed-chunk-10-2.png" width="576"></p>
<p>We can also compute the marginal effect of the cyclic confounder</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compute partial dependence plot</span></span>
<span><span class="va">Partial</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/pdp/man/partial.html" class="external-link">partial</a></span><span class="op">(</span> object <span class="op">=</span> <span class="va">out</span>,</span>
<span>                   pred.var <span class="op">=</span> <span class="st">"w"</span>,</span>
<span>                   pred.fun <span class="op">=</span> \<span class="op">(</span><span class="va">object</span>,<span class="va">newdata</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">object</span>,<span class="va">newdata</span><span class="op">)</span>,</span>
<span>                   train <span class="op">=</span> <span class="va">Data</span>,</span>
<span>                   approx <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Lattice plots as default option</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pdp/man/plotPartial.html" class="external-link">plotPartial</a></span><span class="op">(</span> <span class="va">Partial</span> <span class="op">)</span></span></code></pre></div>
<p><img src="spatial_files/figure-html/unnamed-chunk-11-1.png" width="576"></p>
<p>Alternatively, we can use the <code>predict</code> function to plot
confidence intervals for marginal effects:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create new data frame</span></span>
<span><span class="va">newdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>w <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">Data</span><span class="op">$</span><span class="va">w</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">Data</span><span class="op">$</span><span class="va">w</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">newdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="va">newdata</span>, <span class="st">'x'</span><span class="op">=</span><span class="fl">13</span>, <span class="st">'y'</span><span class="op">=</span><span class="fl">13</span>, <span class="st">'var'</span><span class="op">=</span><span class="st">'n'</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># make predictions</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span> <span class="va">out</span>, newdata<span class="op">=</span><span class="va">newdata</span>, se.fit<span class="op">=</span><span class="cn">TRUE</span>, what<span class="op">=</span><span class="st">"p_g"</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Format as data frame and plot</span></span>
<span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span> <span class="va">newdata</span>, <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">w</span>, y<span class="op">=</span><span class="va">fit</span>,</span>
<span>  ymin <span class="op">=</span> <span class="va">fit</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se.fit</span>, ymax <span class="op">=</span> <span class="va">fit</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">se.fit</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p><img src="spatial_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James T. Thorson, Sean C. Anderson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
